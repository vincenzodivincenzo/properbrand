<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proper Brand - Pomodoro Timer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Only adding styles not covered in style.css */
        .tomato-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0;
            display: inline-block;
            vertical-align: middle;
        }

        .tomato {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #07efce 0%, #06d9b9 100%);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(7, 239, 206, 0.3);
        }

        .tomato.work {
            background: linear-gradient(135deg, #07efce 0%, #06d9b9 100%);
        }

        .tomato.break {
            background: linear-gradient(135deg, #06d9b9 0%, #07efce 100%);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 10px;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #07efce 0%, #06d9b9 100%);
            width: 0%;
            transition: width 1s linear;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
    </style>
</head>
<body class="bg-[#161616] text-white">
    <!-- Navbar -->
    <nav class="relative px-4 pt-6">
        <div class="max-w-6xl mx-auto">
            <div class="w-full flex flex-wrap justify-between items-center mb-8 fade-in">
                <div class="flex items-center gap-2">
                    <a href="https://www.properbrand.co" class="flex items-center gap-2 hover:opacity-80 transition-all">
                        <div class="w-6 h-6 bg-[#07efce] rounded-full"></div>
                        <span class="text-xl font-medium text-white">Proper Brand</span>
                    </a>
                </div>
                <div class="flex gap-3">
                    <a href="https://www.properbrand.co" class="px-4 py-2 text-sm font-medium border border-[#07efce]/30 text-white rounded-lg hover:bg-[#07efce]/10 transition-all hover:border-[#07efce]">
                        Back to home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 pb-20">
        <!-- Title and Subtitle Section -->
        <div class="text-center max-w-2xl mx-auto mb-12 fade-in">
            <h1 class="text-4xl md:text-5xl font-medium mb-6 text-white">
                Unlock <span class="font-playfair italic text-[#07efce]">Proper</span> Focus
            </h1>
            <p class="text-lg text-gray-300">
                A small Pomodoro timer designed for impact makers. Use it for free
            </p>
        </div>

        <!-- Tool Container -->
        <div class="flex justify-center">
            <!-- Unified Card for Desktop -->
            <div class="bg-[#1a1a1a] rounded-2xl border border-[#07efce]/20 shadow-lg fade-in">
                <!-- Mobile: Stack both sections, Desktop: Side by side -->
                <div class="flex flex-col lg:flex-row lg:divide-x lg:divide-[#07efce]/10">
                    <!-- Timer Section -->
                    <div class="p-8 lg:w-1/2">
                        <!-- Timer and Pomodoro Section -->
                        <div class="flex items-center gap-6 mb-4">
                            <div class="flex-1">
                                <div id="modeDisplay" class="text-[#07efce] text-xl font-medium mb-2">Work Time</div>
                                <div id="timer" class="text-5xl font-bold">25:00</div>
                            </div>
                            <div class="tomato-container">
                                <div class="tomato work hover-glow">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add Work Label Input Field -->
                        <div class="mb-4">
                            <label for="workLabel" class="text-sm text-gray-400 mb-1">Current Task</label>
                            <input type="text" id="workLabel" placeholder="What are you working on?" 
                                   class="w-full px-3 py-2 bg-[#161616] border border-[#07efce]/30 rounded-lg text-white focus:border-[#07efce] focus:outline-none">
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress"></div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
                            <button id="start" class="px-4 py-3 text-sm font-medium text-[#161616] bg-[#07efce] rounded-lg hover:bg-[#06d9b9] transition-all hover-glow">
                                Start
                            </button>
                            <button id="pause" class="px-4 py-3 text-sm font-medium text-[#161616] bg-[#07efce] rounded-lg hover:bg-[#06d9b9] transition-all hover-glow">
                                Pause
                            </button>
                            <button id="reset" class="px-4 py-3 text-sm font-medium border border-[#07efce]/30 text-white rounded-lg hover:bg-[#07efce]/10 transition-all hover:border-[#07efce]">
                                Reset
                            </button>
                            <button id="skip" class="px-4 py-3 text-sm font-medium border border-[#07efce]/30 text-white rounded-lg hover:bg-[#07efce]/10 transition-all hover:border-[#07efce]">
                                Skip
                            </button>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div class="flex flex-col">
                                <label for="workMinutes" class="text-sm text-gray-400 mb-1">Work (min)</label>
                                <input type="number" id="workMinutes" min="1" max="60" value="25" 
                                       class="w-full px-3 py-2 bg-[#161616] border border-[#07efce]/30 rounded-lg text-center text-white focus:border-[#07efce] focus:outline-none">
                            </div>
                            <div class="flex flex-col">
                                <label for="breakMinutes" class="text-sm text-gray-400 mb-1">Break (min)</label>
                                <input type="number" id="breakMinutes" min="1" max="30" value="5" 
                                       class="w-full px-3 py-2 bg-[#161616] border border-[#07efce]/30 rounded-lg text-center text-white focus:border-[#07efce] focus:outline-none">
                            </div>
                            <div class="flex flex-col">
                                <label for="longBreakMinutes" class="text-sm text-gray-400 mb-1">Long Break (min)</label>
                                <input type="number" id="longBreakMinutes" min="1" max="60" value="15" 
                                       class="w-full px-3 py-2 bg-[#161616] border border-[#07efce]/30 rounded-lg text-center text-white focus:border-[#07efce] focus:outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Stats and History Section -->
                    <div class="border-t border-[#07efce]/10 lg:border-t-0 p-8 lg:w-1/2">
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div class="bg-[#161616]/60 p-4 rounded-xl border border-[#07efce]/10">
                                <p class="text-sm text-gray-400">Sessions Completed</p>
                                <p id="sessionsCount" class="text-2xl font-bold text-[#07efce]">0</p>
                            </div>
                            <div class="bg-[#161616]/60 p-4 rounded-xl border border-[#07efce]/10">
                                <p class="text-sm text-gray-400">Total Focus Time</p>
                                <p><span id="totalTime" class="text-2xl font-bold text-[#07efce]">0</span> <span class="text-gray-400">min</span></p>
                            </div>
                        </div>

                        <!-- History Section -->
                        <div class="border-t border-[#07efce]/10 pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-medium">Session History</h3>
                                <div class="flex gap-2">
                                    <button id="exportHistory" class="px-3 py-1 text-xs font-medium bg-[#161616] border border-[#07efce]/30 text-white rounded-lg hover:bg-[#07efce]/10 transition-all hover:border-[#07efce]">
                                        Export CSV
                                    </button>
                                    <label for="importFile" class="px-3 py-1 text-xs font-medium bg-[#161616] border border-[#07efce]/30 text-white rounded-lg hover:bg-[#07efce]/10 transition-all hover:border-[#07efce] cursor-pointer">
                                        Import CSV
                                    </label>
                                    <input type="file" id="importFile" accept=".csv" class="hidden">
                                    <button id="clearHistory" class="px-3 py-1 text-xs font-medium bg-[#161616] border border-[#07efce]/30 text-white rounded-lg hover:bg-[#07efce]/10 transition-all hover:border-[#07efce]">
                                        Clear History
                                    </button>
                                </div>
                            </div>
                            <div class="history-list rounded-xl border border-[#07efce]/10 bg-[#161616]/60 p-4 h-[calc(100vh-600px)] min-h-[200px] overflow-y-auto" id="historyList">
                                <!-- History items will be added here -->
                            </div>
                        </div>
                        
                        <!-- Sound controls -->
                        <div class="border-t border-[#07efce]/10 pt-6 mt-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium">Sound Settings</h3>
                                <div class="flex items-center">
                                    <label for="volumeControl" class="text-sm text-gray-400 mr-2">Volume</label>
                                    <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="0.7" 
                                           class="w-24 accent-[#07efce]">
                                </div>
                            </div>
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="muteSound" class="mr-2 accent-[#07efce]">
                                <label for="muteSound" class="text-sm text-gray-400">Mute all sounds</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio for sounds -->
    <audio id="buttonClickSound">
        <source src="button-click.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="timerEndSound">
        <source src="end-timer.mp3" type="audio/mpeg">
    </audio>

    <!-- Footer -->
    <footer class="bg-[#111111] py-8 border-t border-[#07efce]/10">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex items-center justify-center gap-2 mb-4">
                <div class="w-4 h-4 bg-[#07efce] rounded-full"></div>
                <span class="text-md font-medium text-white">Proper Brand</span>
            </div>
            <p class="text-center text-gray-400 text-sm">
                A tool for impact makers who value their time. © 2025 Proper Brand.
            </p>
        </div>
    </footer>

    <script>
        // Create a Web Worker for accurate timing
        const timerWorker = new Worker(URL.createObjectURL(new Blob([`
            let timer;
            self.onmessage = function(e) {
                if (e.data === 'start') {
                    timer = setInterval(() => {
                        self.postMessage('tick');
                    }, 1000);
                } else if (e.data === 'stop') {
                    clearInterval(timer);
                }
            };
        `], { type: 'text/javascript' })));

        const timerDisplay = document.getElementById('timer');
        const startButton = document.getElementById('start');
        const pauseButton = document.getElementById('pause');
        const resetButton = document.getElementById('reset');
        const skipButton = document.getElementById('skip');
        const workMinutesInput = document.getElementById('workMinutes');
        const breakMinutesInput = document.getElementById('breakMinutes');
        const longBreakMinutesInput = document.getElementById('longBreakMinutes');
        const progressBar = document.getElementById('progress');
        const modeDisplay = document.getElementById('modeDisplay');
        const sessionsCount = document.getElementById('sessionsCount');
        const totalTime = document.getElementById('totalTime');
        
        // Sound elements
        const buttonClickSound = document.getElementById('buttonClickSound');
        const timerEndSound = document.getElementById('timerEndSound');
        const volumeControl = document.getElementById('volumeControl');
        const muteSound = document.getElementById('muteSound');

        let timer;
        let timeLeft;
        let isRunning = false;
        let totalTimeSpent = 0;
        let sessionsCompleted = 0;
        let isWorkMode = true;
        let pomodoroSequence = 0;
        let totalInitialTime;
        let sessionHistory = [];
        let startTime; // Track when the timer started
        let elapsedTime = 0; // Track elapsed time for accurate skipping

        // Sound functions
        function playButtonSound() {
            if (!muteSound.checked) {
                buttonClickSound.volume = parseFloat(volumeControl.value);
                buttonClickSound.currentTime = 0;
                buttonClickSound.play();
            }
        }
        
        function playTimerEndSound() {
            if (!muteSound.checked) {
                timerEndSound.volume = parseFloat(volumeControl.value);
                timerEndSound.currentTime = 0;
                timerEndSound.play();
            }
        }
        
        // Add click sound to all buttons
        document.querySelectorAll('button, input[type="checkbox"], input[type="range"]').forEach(element => {
            element.addEventListener('click', playButtonSound);
        });

        // Update button states
        function updateButtonStates() {
            if (isRunning) {
                startButton.disabled = true;
                startButton.classList.remove('bg-[#07efce]', 'hover:bg-[#06d9b9]');
                startButton.classList.add('bg-gray-500', 'cursor-not-allowed');
            } else {
                startButton.disabled = false;
                startButton.classList.add('bg-[#07efce]', 'hover:bg-[#06d9b9]');
                startButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
            }
        }

        // Check for saved settings and history in localStorage
        function loadSavedData() {
            if (localStorage.getItem('pomodoroSettings')) {
                const settings = JSON.parse(localStorage.getItem('pomodoroSettings'));
                workMinutesInput.value = settings.work;
                breakMinutesInput.value = settings.break;
                longBreakMinutesInput.value = settings.longBreak;
                totalTimeSpent = settings.totalTime || 0;
                sessionsCompleted = settings.sessions || 0;
                
                // Load sound settings if available
                if (settings.volume !== undefined) {
                    volumeControl.value = settings.volume;
                }
                if (settings.mute !== undefined) {
                    muteSound.checked = settings.mute;
                }
            }
            
            if (localStorage.getItem('pomodoroHistory')) {
                sessionHistory = JSON.parse(localStorage.getItem('pomodoroHistory'));
                updateHistoryDisplay();
            }
            
            updateStats();
        }

        function saveSettings() {
            const settings = {
                work: workMinutesInput.value,
                break: breakMinutesInput.value,
                longBreak: longBreakMinutesInput.value,
                totalTime: totalTimeSpent,
                sessions: sessionsCompleted,
                volume: volumeControl.value,
                mute: muteSound.checked
            };
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
        }

        function saveHistory() {
            localStorage.setItem('pomodoroHistory', JSON.stringify(sessionHistory));
        }

        function updateDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            const progress = ((totalInitialTime - seconds) / totalInitialTime) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function updateStats() {
            sessionsCount.textContent = sessionsCompleted;
            totalTime.textContent = totalTimeSpent;
            saveSettings();
        }

        // Updated addHistoryEntry to accept a label parameter
        function addHistoryEntry(type, duration, label = "") {
            const now = new Date();
            
            const entry = {
                type: type,
                duration: duration,
                timestamp: now.toISOString(),
                completed: true,
                label: label  // Use the provided label
            };
            
            sessionHistory.unshift(entry);
            if (sessionHistory.length > 50) {
                sessionHistory = sessionHistory.slice(0, 50);
            }
            updateHistoryDisplay();
            saveHistory();
        }

        // Improved history display for better label visibility
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (sessionHistory.length === 0) {
                historyList.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No sessions recorded yet</p>';
                return;
            }
            
            sessionHistory.forEach(entry => {
                const date = new Date(entry.timestamp);
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateString = date.toLocaleDateString();
                
                const historyItem = document.createElement('div');
                historyItem.className = 'py-2 border-b border-[#07efce]/10 last:border-b-0';
                
                const typeColor = entry.type.toLowerCase().includes('work') ? '#07efce' : '#06d9b9';
                
                // Create a more structured layout for history items
                let historyHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <span class="font-medium" style="color: ${typeColor}">${entry.type}</span>`;
                
                // Add label with better styling if it exists
                if (entry.label && entry.type.toLowerCase().includes('work')) {
                    historyHTML += `
                            <div class="mt-1 text-white text-sm bg-[#161616]/80 px-2 py-1 rounded-md inline-block">
                                ${entry.label}
                            </div>`;
                }
                
                historyHTML += `
                        </div>
                        <div class="text-right">
                            <span class="text-gray-400">${entry.duration} min</span>
                            <div class="text-gray-400 text-xs">${dateString} ${timeString}</div>
                        </div>
                    </div>
                `;
                
                historyItem.innerHTML = historyHTML;
                historyList.appendChild(historyItem);
            });
        }

        // Modified switchMode to get label before completing a session
        function switchMode() {
            // Add completed session to history
            if (isWorkMode) {
                // Play timer end sound
                playTimerEndSound();
                
                // Get the label from the input field
                const label = document.getElementById('workLabel').value || "";
                addHistoryEntry('Work', workMinutesInput.value, label);
                
                // Clear the label for the next session
                document.getElementById('workLabel').value = "";
            } else {
                // Play timer end sound
                playTimerEndSound();
                
                addHistoryEntry(pomodoroSequence === 3 ? 'Long Break' : 'Break', 
                              pomodoroSequence === 3 ? longBreakMinutesInput.value : breakMinutesInput.value);
            }
            
            isWorkMode = !isWorkMode;
            if (isWorkMode) {
                timeLeft = workMinutesInput.value * 60;
                modeDisplay.textContent = "Work Time";
                modeDisplay.style.color = "#07efce";
                document.querySelector('.tomato').className = "tomato work hover-glow";
            } else {
                if (pomodoroSequence === 3) {
                    timeLeft = longBreakMinutesInput.value * 60;
                    modeDisplay.textContent = "Long Break";
                    pomodoroSequence = 0;
                } else {
                    timeLeft = breakMinutesInput.value * 60;
                    modeDisplay.textContent = "Break Time";
                    pomodoroSequence++;
                }
                modeDisplay.style.color = "#06d9b9";
                document.querySelector('.tomato').className = "tomato break hover-glow";
            }
            totalInitialTime = timeLeft;
            updateDisplay(timeLeft);
        }

        // Updated startTimer function to use Web Worker
        function startTimer() {
            if (!isRunning) {
                playButtonSound();
                isRunning = true;
                startTime = Date.now();
                updateButtonStates();
                
                timerWorker.postMessage('start');
                timerWorker.onmessage = function(e) {
                    if (e.data === 'tick') {
                        if (timeLeft > 0) {
                            timeLeft--;
                            updateDisplay(timeLeft);
                            if (isWorkMode) {
                                totalTimeSpent = Math.floor(totalTimeSpent + 1/60);
                                updateStats();
                            }
                        } else {
                            timerWorker.postMessage('stop');
                            isRunning = false;
                            updateButtonStates();
                            
                            // Timer complete - play end sound
                            playTimerEndSound();
                            
                            if (isWorkMode) {
                                sessionsCompleted++;
                                updateStats();
                            }
                            switchMode();
                        }
                    }
                };
            }
        }

        function pauseTimer() {
            timerWorker.postMessage('stop');
            isRunning = false;
            updateButtonStates();
            if (startTime) {
                elapsedTime += (Date.now() - startTime) / 1000;
            }
        }

        function resetTimer() {
            timerWorker.postMessage('stop');
            isRunning = false;
            updateButtonStates();
            isWorkMode = true;
            pomodoroSequence = 0;
            timeLeft = workMinutesInput.value * 60;
            totalInitialTime = timeLeft;
            elapsedTime = 0;
            modeDisplay.textContent = "Work Time";
            modeDisplay.style.color = "#07efce";
            document.querySelector('.tomato').className = "tomato work hover-glow";
            updateDisplay(timeLeft);
        }

        function skipSession() {
            timerWorker.postMessage('stop');
            isRunning = false;
            updateButtonStates();
            
            if (isWorkMode) {
                // Calculate actual time spent in minutes
                const actualTimeSpent = Math.floor(elapsedTime / 60);
                const label = document.getElementById('workLabel').value || "";
                addHistoryEntry('Work', actualTimeSpent, label);
                sessionsCompleted++;
                updateStats();
            }
            
            elapsedTime = 0;
            switchMode();
        }

        // Bug fix 1: Preserve session stats when clearing history
        function clearHistory() {
            // Only clear the history array, preserve stats
            sessionHistory = [];
            saveHistory();
            updateHistoryDisplay();
            // Don't reset sessions completed or total time
        }

        // Export history to CSV
        function exportHistoryToCSV() {
            if (sessionHistory.length === 0) {
                alert('No sessions to export');
                return;
            }
            
            // Create CSV header
            let csvContent = 'Type,Label,Duration (minutes),Start Date,Start Time,End Date,End Time\n';
            
            // Add each session to CSV
            sessionHistory.forEach(entry => {
                const startDate = new Date(entry.timestamp);
                
                // Calculate end time by adding duration
                const endDate = new Date(startDate.getTime() + (entry.duration * 60 * 1000));
                
                // Format dates for CSV
                const startDateStr = startDate.toLocaleDateString();
                const startTimeStr = startDate.toLocaleTimeString();
                const endDateStr = endDate.toLocaleDateString();
                const endTimeStr = endDate.toLocaleTimeString();
                
                // Escape label content for CSV (replace commas and quotes)
                const safeLabel = entry.label ? `"${entry.label.replace(/"/g, '""')}"` : '';
                
                // Add row to CSV
                csvContent += `${entry.type},${safeLabel},${entry.duration},${startDateStr},${startTimeStr},${endDateStr},${endTimeStr}\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            // Set filename with current date
            const today = new Date();
            const filename = `pomodoro_history_${today.toISOString().split('T')[0]}.csv`;
            
            // Download file
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Import history from CSV
        function importHistoryFromCSV(file) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const csvData = event.target.result;
                const lines = csvData.split('\n');
                
                // Skip header row
                if (lines.length <= 1) {
                    alert('CSV file is empty or invalid');
                    return;
                }
                
                // Clear existing history (optional - could also append)
                if (confirm('Replace existing history with imported data?')) {
                    sessionHistory = [];
                }
                
                // Parse each line (skipping header)
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue; // Skip empty lines
                    
                    const columns = parseCSVLine(lines[i]);
                    
                    if (columns.length >= 5) {
                        // Extract data
                        const type = columns[0];
                        const label = columns[1].replace(/^"|"$/g, '').replace(/""/g, '"'); // Remove CSV quotes
                        const duration = parseInt(columns[2]) || 0;
                        
                        // Parse start date/time
                        let startDateStr = columns[3];
                        let startTimeStr = columns[4];
                        
                        // Create timestamp from date/time strings
                        const dateParts = startDateStr.split('/');
                        if (dateParts.length === 3) {
                            // Try to parse date in various formats
                            let startDate;
                            try {
                                // Try to parse the date
                                startDate = new Date(`${startDateStr} ${startTimeStr}`);
                                
                                // If invalid, try alternative format
                                if (isNaN(startDate.getTime())) {
                                    // Try MM/DD/YYYY format
                                    startDate = new Date(`${dateParts[0]}/${dateParts[1]}/${dateParts[2]} ${startTimeStr}`);
                                }
                            } catch (e) {
                                console.error('Error parsing date:', e);
                                continue;
                            }
                            
                            if (!isNaN(startDate.getTime())) {
                                // Add to history if date parsing succeeded
                                sessionHistory.push({
                                    type: type,
                                    label: label,
                                    duration: duration,
                                    timestamp: startDate.toISOString(),
                                    completed: true
                                });
                            }
                        }
                    }
                }
                
                // Sort history by timestamp (newest first)
                sessionHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Update display and save
                updateHistoryDisplay();
                saveHistory();
                
                alert('History imported successfully!');
            };
            
            reader.onerror = function() {
                alert('Failed to read the file');
            };
            
            reader.readAsText(file);
        }

        // Helper function to parse CSV lines properly (handles quoted fields with commas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    // Toggle quote mode
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    // End of field if comma is outside quotes
                    result.push(current);
                    current = '';
                } else {
                    // Add character to current field
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current);
            
            return result;
        }

        // Save sound settings when changed
        volumeControl.addEventListener('change', saveSettings);
        muteSound.addEventListener('change', saveSettings);

        startButton.addEventListener('click', startTimer);
        pauseButton.addEventListener('click', pauseTimer);
        resetButton.addEventListener('click', resetTimer);
        skipButton.addEventListener('click', skipSession);
        workMinutesInput.addEventListener('change', () => {
            saveSettings();
            if (isWorkMode) resetTimer();
        });
        breakMinutesInput.addEventListener('change', () => {
            saveSettings();
            if (!isWorkMode && pomodoroSequence !== 3) resetTimer();
        });
        longBreakMinutesInput.addEventListener('change', () => {
            saveSettings();
            if (!isWorkMode && pomodoroSequence === 3) resetTimer();
        });

        // Add event listeners for export/import
        document.getElementById('exportHistory').addEventListener('click', exportHistoryToCSV);

        document.getElementById('importFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                importHistoryFromCSV(file);
            }
            // Clear the input so the same file can be selected again
            this.value = '';
        });

        // Initialize the timer and history
        loadSavedData();
        resetTimer();
        updateButtonStates(); // Set initial button states
        
        // Add clear history button listener
        document.getElementById('clearHistory').addEventListener('click', clearHistory);

        // Fade-in animation
        document.addEventListener('DOMContentLoaded', function() {
            const fadeElements = document.querySelectorAll('.fade-in');
            fadeElements.forEach((element, index) => {
                element.style.animationDelay = `${0.2 * index}s`;
            });
        });
    </script>
</body>
</html>
